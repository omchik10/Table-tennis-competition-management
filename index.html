<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>× ×™×”×•×œ ×ª×—×¨×•×™×•×ª ×˜× ×™×¡ ×©×•×œ×—×Ÿ</title>
<style>
/*×¢×™×¦×•×‘ ×¨××©×™*/
body { font-family: Tahoma, Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }
h1, h2 { text-align:center; color:#002b7f; margin-top:30px; }
h1 { font-size:28px; }

/* ×˜××‘×™× ×©×œ ×ª×—×¨×•×™×•×ª */
#tournamentTabs { 
  overflow:hidden; border-bottom:3px solid #444; margin-top:20px; 
  display:flex; justify-content:center; flex-wrap:wrap; gap:8px; 
}
#tournamentTabs button { 
  background:#e0e0e0; border:2px solid #888; cursor:pointer; padding:12px 20px; 
  font-size:18px; border-radius:10px 10px 0 0; font-weight:bold; transition:0.3s;
}
#tournamentTabs button:hover { background:#d0d0d0; }
#tournamentTabs button.active { 
  background:#002b7f; color:white; border:2px solid #002b7f; 
  border-bottom:3px solid white; transform:translateY(2px);
}

/* ×ª×•×›×Ÿ ×›×œ ×ª×—×¨×•×ª */
.tournamentContent { display:none; padding:20px; text-align:center; }
.tournamentContent.active { display:block; }

/* ×˜××‘×™× ×¤× ×™××™×™× */
.tab { overflow:hidden; border-bottom:1px solid #ccc; margin-top:20px; display:flex; justify-content:center; flex-wrap:wrap; gap:5px; }
.tab button { background:#eee; border:1px solid #aaa; cursor:pointer; padding:8px 14px; font-size:15px; border-radius:6px 6px 0 0; }
.tab button:hover { background:#ddd; }
.tab button.active { background:#ccc; font-weight:bold; }
.tabcontent { display:none; padding:10px 0; text-align:center; }

/* ×˜×‘×œ××•×ª */
table { border-collapse:collapse; width:80%; margin:20px auto; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
th, td { border:1px solid #000; padding:10px; text-align:center; }
tr:nth-child(even) td { background:#f2f2f2; }

input[type="text"], input[type="number"] { 
  padding:8px; margin:4px; border:1px solid #aaa; 
  border-radius:6px; text-align:center; width:200px; /* ×©×“×” ×©××•×ª ×’×“×•×œ ×™×•×ª×¨ */
}

.hidden { display:none; }

#playerCountSection, #groupsSection, #knockoutSection { display:flex; flex-direction:column; align-items:center; margin-top:30px; }

/* ×‘×¨×§×˜ × ×•×§××•×˜ */
.bracket {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 60px;
  margin: 40px auto;
  direction: rtl;
}
.round {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 40px;
  position: relative;
}
.match {
  background: #fff;
  border: 2px solid #002b7f;
  padding: 10px;
  text-align: center;
  min-width: 160px;
  border-radius: 8px;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  word-break: break-word;
}

/* ×§×•×•×™× ××•×¤×§×™×™× ×©××—×‘×¨×™× ×©×—×§× ×™× ×œ×¨××•× ×“ ×”×‘× */
.match::after {
  content: "";
  position: absolute;
  left: 100%;
  top: 50%;
  width: 30px;
  height: 2px;
  background: #000;
}

/* ×§×•×•×™× ×× ×›×™×™× â€“ ××—×‘×¨×™× ×–×•×’ ××©×—×§×™× ×œ×›× ×™×¡×” ××—×ª */
.round::after {
  content: "";
  position: absolute;
  left: 100%;
  top: 20px;
  bottom: 20px;
  width: 2px;
  background: #000;
}

.round:last-child::after,
.round:last-child .match::after {
  display: none;
}

/* ×ª×¦×•×’×ª ×× ×¦×— */
.champion {
  margin-top: 12px;
  font-size: 18px;
  font-weight: bold;
  color: #0a3f7a;
}

/* ×¡×’× ×•×Ÿ ×œ××§×¨×” ×©×œ ×× ×¦×— ××•×˜×•××˜×™ */
.match .auto {
  margin-top:6px;
  font-weight:700;
  color:#007a00;
}

footer {
    text-align: center;     /* ×××•×¨×›×– */
    font-size: 14px;        /* ×˜×§×¡×˜ ×§×˜×Ÿ */
    color: #666;            /* ××¤×•×¨ ×¢×“×™×Ÿ */
    padding: 10px;
    border-top: 1px solid #ccc; /* ×§×• ×¢×œ×™×•×Ÿ */
    margin-top: 20px;
}
.hidden { display: none; }
.bracket { display: flex; flex-direction: row; gap: 20px; }
.round { display: flex; flex-direction: column; justify-content: space-around; }
.match { border: 1px solid #ccc; padding: 5px; margin: 10px 0; background: #f9f9f9; }
.tournamentContent { display: none; }
.tournamentContent.active { display: block; }

</style>
</head>
<body>
<h1>× ×™×”×•×œ ×ª×—×¨×•×™×•×ª ×˜× ×™×¡ ×©×•×œ×—×Ÿ</h1>

<div style="text-align:center; margin-top:20px;">
  <button onclick="addTournament()">â• ×œ×”×•×¡×¤×ª ×ª×—×¨×•×ª</button>
</div>

<div id="tournamentTabs"></div>
<div id="tournamentContainer"></div>

<script>
let tournamentCount = 0;
let tournaments = {}; 

function addTournament(){
  const name = prompt("×”×›× ×¡ ×©× ×œ×ª×—×¨×•×ª:");
  if(!name) return;

  tournamentCount++;
  const tid = "tournament"+tournamentCount;

  // ×›×¤×ª×•×¨ ×˜××‘
  const tabBtn = document.createElement("button");
  tabBtn.textContent = name;
  tabBtn.id = "tabbtn_"+tid;
  tabBtn.onclick = ()=>openTournament(tid);
  tabBtn.style.position = "relative";

  // ×›×¤×ª×•×¨ X ×œ×¡×’×™×¨×ª ×”×ª×—×¨×•×ª
  const closeBtn = document.createElement("span");
  closeBtn.textContent = "âœ–";
  closeBtn.style.position = "absolute";
  closeBtn.style.left = "5px";
  closeBtn.style.top = "2px";
  closeBtn.style.cursor = "pointer";
  closeBtn.style.color = "#900";
  closeBtn.style.fontWeight = "bold";
  closeBtn.title = "×¡×’×•×¨ ×ª×—×¨×•×ª";
  closeBtn.onclick = (e)=>{
      e.stopPropagation();
      if(confirm(`××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ×¡×’×•×¨ ××ª ×”×ª×—×¨×•×ª: "${name}"?`)){
          closeTournament(tid);
      }
  };
  tabBtn.appendChild(closeBtn);
  document.getElementById("tournamentTabs").appendChild(tabBtn);

  // ×ª×•×›×Ÿ ×”×ª×—×¨×•×ª
  const contentDiv = document.createElement("div");
  contentDiv.className="tournamentContent";
  contentDiv.id=tid;
  contentDiv.innerHTML=`
    <h2>${name}</h2>
    <div id="playerCountSection${tid}">
      <label>×›××” ×‘×ª×™× (16-1):</label>
      <input type="number" min="1" max="16" id="groupCountInput${tid}" placeholder="×‘×—×¨ ××¡×¤×¨ ×‘×ª×™×">
      <button id="create-groups${tid}">×¦×•×¨ ×‘×ª×™×</button>
    </div>
    <div id="groupsSection${tid}" class="hidden"></div>
    <div id="knockoutSection${tid}" class="hidden">
      <h2 style="text-align:center;">×¢×¥ × ×•×§××•×˜</h2>
      <button onclick="generateKnockout('${tid}')">×¦×•×¨ ×¢×¥ × ×•×§××•×˜</button>
      <div id="bracket${tid}" class="bracket"></div>
      <div id="champion${tid}" class="champion"></div>
    </div>`;

  document.getElementById("tournamentContainer").appendChild(contentDiv);

  tournaments[tid] = {
    groups: [],
    groupCount: 0,
    knockoutPlayers: [],
    rounds:[]
  };

  document.getElementById("create-groups"+tid).addEventListener("click", ()=>createGroups(tid));
  openTournament(tid);
}

function openTournament(tid){
  document.querySelectorAll("#tournamentTabs button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tournamentContent").forEach(c=>c.classList.remove("active"));
  document.getElementById("tabbtn_"+tid).classList.add("active");
  document.getElementById(tid).classList.add("active");
}

function createGroups(tid) {
  const sel = document.getElementById("groupCountInput"+tid);
  let groupCount = parseInt(sel.value,10);
  if(isNaN(groupCount) || groupCount<1 || groupCount>16) { alert("×™×© ×œ×‘×—×•×¨ ××¡×¤×¨ ×‘×™×Ÿ 1 ×œ-16"); return; }
  tournaments[tid].groupCount = groupCount;
  tournaments[tid].groups = [];
  for(let g=0; g<groupCount; g++) tournaments[tid].groups.push([]);
  renderGroups(tid);
}

function renderGroups(tid) {
  const tdata = tournaments[tid];
  const container = document.getElementById("groupsSection"+tid);
  container.innerHTML = '';
  const tabDiv = document.createElement("div");
  tabDiv.className='tab';
  for(let g=0; g<tdata.groupCount; g++){
    const btn = document.createElement("button");
    btn.textContent = `×‘×™×ª ${g+1}`;
    btn.onclick = ()=>openGroupTab(tid,g);
    if(g===0) btn.className='active';
    tabDiv.appendChild(btn);
  }
  if(tdata.groupCount>1){
    const knockoutBtn = document.createElement("button");
    knockoutBtn.textContent="×¢×¥ × ×•×§××•×˜";
    knockoutBtn.onclick = ()=>openKnockoutTab(tid);
    tabDiv.appendChild(knockoutBtn);
  }
  container.appendChild(tabDiv);

  for(let g=0; g<tdata.groupCount; g++){
    const div = document.createElement("div");
    div.id=`${tid}_group${g}`;
    div.className='tabcontent';
    if(g===0) div.style.display='block';
   div.innerHTML = `
      <div style="background:#f0f4f8; padding:15px; border-radius:10px; border:1px solid #d1d9e6; margin-bottom:20px;">
        <h4 style="margin-top:0;">×”×’×“×¨×•×ª ×”×‘×™×ª:</h4>
        
        <label>×©×™×˜×ª ××©×—×§:</label>
        <select id="${tid}_matchType${g}" style="padding:5px; border-radius:5px; margin-left:15px;">
          <option value="1">××¢×¨×›×” ××—×ª (×¢×“ 11)</option>
          <option value="3">×”×˜×•×‘ ×-3 ××¢×¨×›×•×ª</option>
          <option value="5">×”×˜×•×‘ ×-5 ××¢×¨×›×•×ª</option>
          <option value="7">×”×˜×•×‘ ×-7 ××¢×¨×›×•×ª</option>
        </select>

        <label>×›××” ×©×—×§× ×™× (3â€“20):</label>
        <input type="number" min="3" max="20" id="${tid}_playerCount${g}" style="width:60px;" placeholder="3">
        
        <button id="${tid}_setupBtn${g}" style="background:#002b7f; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">
          ××©×¨ ×•×¦×•×¨ ×©×—×§× ×™×
        </button>
      </div>

      <div id="${tid}_playersInputs${g}"></div>
      <div id="${tid}_preRanking${g}"></div>
      <div id="${tid}_matches${g}"></div>
      <div id="${tid}_ranking${g}"></div>
    `;
    container.appendChild(div);
    document.getElementById(`${tid}_setupBtn${g}`).addEventListener("click", ()=>setupPlayers(tid,g));
  }
  container.classList.remove("hidden");
  document.getElementById("knockoutSection"+tid).style.display='none';
}

function openGroupTab(tid,index){
  const tabcontent = document.querySelectorAll(`#groupsSection${tid} .tabcontent`);
  tabcontent.forEach(c=>c.style.display='none');
  tabcontent[index].style.display='block';
  const tabbuttons = document.querySelectorAll(`#groupsSection${tid} .tab button`);
  tabbuttons.forEach(b=>b.classList.remove("active"));
  tabbuttons[index].classList.add("active");
  document.getElementById("knockoutSection"+tid).style.display='none';
}

function openKnockoutTab(tid){
  const tabcontent = document.querySelectorAll(`#groupsSection${tid} .tabcontent`);
  tabcontent.forEach(c=>c.style.display='none');
  document.getElementById("knockoutSection"+tid).style.display='block';
  const tabbuttons = document.querySelectorAll(`#groupsSection${tid} .tab button`);
  tabbuttons.forEach(b=>b.classList.remove("active"));
  tabbuttons[tabbuttons.length-1].classList.add("active");
}

function isNameTaken(tid, name, currentGroupIdx, currentPlayerIdx) {
    if (!name || name.trim() === "") return false;
    const tdata = tournaments[tid];
    
    for (let g = 0; g < tdata.groups.length; g++) {
        for (let p = 0; p < tdata.groups[g].length; p++) {
            // ×× ××¦×× ×• ×©× ×–×”×” ×‘××™×§×•× ××—×¨ (×œ× ×”×©×—×§×Ÿ ×”× ×•×›×—×™ ×©×× ×—× ×• ×¢×•×¨×›×™×)
            if (tdata.groups[g][p].name === name.trim() && 
                (g !== currentGroupIdx || p !== currentPlayerIdx)) {
                return true;
            }
        }
    }
    return false;
}

function setupPlayers(tid, gIndex) {
    const n = parseInt(document.getElementById(`${tid}_playerCount${gIndex}`).value, 10);
    if (isNaN(n) || n < 3 || n > 20) { alert("×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×‘×™×Ÿ 3 ×œ-20"); return; }

    const div = document.getElementById(`${tid}_playersInputs${gIndex}`);
    div.innerHTML = '';
    tournaments[tid].groups[gIndex] = Array(n).fill(null).map(() => ({ name: '', points: 0, wins: 0 }));

    for (let i = 0; i < n; i++) {
        const input = document.createElement("input");
        input.type = 'text';
        input.placeholder = `×©× ×©×—×§×Ÿ ${i + 1}`;
        input.oninput = (e) => {
            const val = e.target.value.trim();
            // ×¢×“×›×•×Ÿ ×”×©× ×‘×–××Ÿ ×××ª
            tournaments[tid].groups[gIndex][i].name = val;
            
            if (isNameTaken(tid, val, gIndex, i)) {
                e.target.style.border = "2px solid red";
                e.target.title = "×”×©× ×›×‘×¨ ×§×™×™× ×‘×˜×•×¨× ×™×¨";
            } else {
                e.target.style.border = "";
                updatePreRanking(tid, gIndex);
            }
        };
        div.appendChild(input);
        div.appendChild(document.createElement("br"));
    }

    const btn = document.createElement("button");
    btn.textContent = '×¦×•×¨ ××©×—×§×™×';
    btn.onclick = () => {
        const currentGroup = tournaments[tid].groups[gIndex];
        const names = currentGroup.map(p => p.name.trim());
        
        // ×‘×“×™×§×ª ×©××•×ª ×¨×™×§×™×
        if (names.some(n => n === "")) {
            alert("×©×’×™××”: ×—×•×‘×” ×œ××œ× ××ª ×›×œ ×©××•×ª ×”×©×—×§× ×™× ×œ×¤× ×™ ×©×××©×™×›×™×.");
            return;
        }

        // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×‘×ª×•×š ×”×‘×™×ª ×•×‘×›×œ ×”×˜×•×¨× ×™×¨
        let duplicateFound = false;
        names.forEach((name, idx) => {
            if (isNameTaken(tid, name, gIndex, idx) || names.filter(n => n === name).length > 1) {
                duplicateFound = true;
            }
        });

        if (duplicateFound) {
            alert("×©×’×™××”: × ××¦××• ×©××•×ª ×›×¤×•×œ×™×. ×›×œ ×©×—×§×Ÿ ×—×™×™×‘ ×©× ×™×™×—×•×“×™ ×›×“×™ ×œ×× ×•×¢ ×˜×¢×•×™×•×ª ×‘×¢×¥ ×”× ×•×§××•×˜.");
            return;
        }
        
        createMatches(tid, gIndex);
    };
    div.appendChild(btn);
}

function updatePreRanking(tid,gIndex){
  const players = tournaments[tid].groups[gIndex];
  let rankingHTML=`<h3>×“×™×¨×•×’ ××§×“×™××” ×‘×™×ª ${gIndex+1}</h3><table><thead><tr><th>××§×•×</th><th>×©×—×§×Ÿ</th></tr></thead><tbody>`;
  players.forEach((p,i)=>{ rankingHTML+=`<tr><td>${i+1}</td><td>${p.name}</td></tr>`; });
  rankingHTML+='</tbody></table>';
  document.getElementById(`${tid}_preRanking${gIndex}`).innerHTML = rankingHTML;
}

function getITTFMatchOrder(n) {
  let matches = [];
  if (n === 3) {
    matches = [[0,1],[2,0],[1,2]];
  } else if (n === 4) {
    matches = [[0,1],[2,3],[0,2],[1,3],[0,3],[1,2]];
  } else if (n === 5) {
    matches = [[0,4],[1,3],[2,0],[4,1],[3,2],[0,1],[2,4],[3,0],[1,2],[4,3]];
  } else {
    matches = bergerTable(n);
  }
  return matches;
}

function bergerTable(n){
  let arr = Array.from({length:n},(_,i)=>i);
  if (n % 2 === 1) { arr.push(null); n++; }
  let rounds = n-1;
  let res = [];
  for (let r=0; r<rounds; r++) {
    for (let i=0;i<n/2;i++) {
      let a = arr[i], b = arr[n-1-i];
      if (a!==null && b!==null) res.push([a,b]);
    }
    arr.splice(1,0,arr.pop());
  }
  return res;
}

function createMatches(tid, gIndex) {
    const players = tournaments[tid].groups[gIndex];
    const n = players.length;
    const matchType = parseInt(document.getElementById(`${tid}_matchType${gIndex}`).value);
    const matchesDiv = document.getElementById(`${tid}_matches${gIndex}`);
    
    // ×©××™×¨×ª ×¡×•×’ ×”××©×—×§ ×‘× ×ª×•× ×™ ×”×˜×•×¨× ×™×¨ ×œ×©×™××•×© ×××•×—×¨ ×™×•×ª×¨ ×‘×—×™×©×•×‘
    tournaments[tid].groups[gIndex].matchType = matchType;

    matchesDiv.innerHTML = '<h3>××©×—×§×™×</h3><p style="font-size:0.9em; color:#666;">×™×© ×œ×”×–×™×Ÿ ××ª ×ª×•×¦××ª ×”× ×§×•×“×•×ª ×‘×›×œ ××¢×¨×›×”</p><table><thead><tr><th>××©×—×§</th><th>×©×—×§×Ÿ 1</th><th>×©×—×§×Ÿ 2</th><th>×ª×•×¦××•×ª ××¢×¨×›×•×ª (× ×§×•×“×•×ª)</th></tr></thead><tbody></tbody></table>';
    const tbody = matchesDiv.querySelector("tbody");

    let matchOrder = getITTFMatchOrder(n);

    matchOrder.forEach((pair, index) => {
        const i = pair[0], j = pair[1];
        const tr = document.createElement("tr");
        
        // ×™×¦×™×¨×ª ×ª×™×‘×•×ª ×§×œ×˜ ×œ×¤×™ ××¡×¤×¨ ×”××¢×¨×›×•×ª (×¢×“ ××§×¡×™××•× ××¤×©×¨×™)
        let setsHTML = "";
        for (let s = 1; s <= matchType; s++) {
            setsHTML += `
                <div style="margin-bottom:5px; border-bottom:1px solid #eee;">
                    <small>××¢×¨×›×” ${s}:</small>
                    <input type="number" class="set-s1" placeholder="×©×—×§×Ÿ 1" style="width:50px">
                    <input type="number" class="set-s2" placeholder="×©×—×§×Ÿ 2" style="width:50px">
                </div>`;
        }

        tr.innerHTML = `
            <td>${index + 1}</td>
            <td class="p1-name">${players[i].name}</td>
            <td class="p2-name">${players[j].name}</td>
            <td>${setsHTML}</td>`;
        tbody.appendChild(tr);
    });

    const btn = document.createElement("button");
    btn.textContent = '×—×©×‘ ×“×™×¨×•×’ ×¡×•×¤×™';
    btn.style.marginTop = "20px";
    btn.onclick = () => calculateResults(tid, gIndex);
    matchesDiv.appendChild(btn);
}

function calculateResults(tid, gIndex) {
    const matchesDiv = document.getElementById(`${tid}_matches${gIndex}`);
    const rankingDiv = document.getElementById(`${tid}_ranking${gIndex}`);
    const players = tournaments[tid].groups[gIndex];
    const matchType = players.matchType;
    const rows = Array.from(matchesDiv.querySelectorAll("tbody tr"));

    players.forEach(p => { p.wins = 0; p.points = 0; });

    for (let row of rows) {
        const s1Inputs = row.querySelectorAll(".set-s1");
        const s2Inputs = row.querySelectorAll(".set-s2");
        let p1SetWins = 0;
        let p2SetWins = 0;
        let p1TotalPoints = 0;
        let p2TotalPoints = 0;

        for (let i = 0; i < s1Inputs.length; i++) {
            const val1 = parseFloat(s1Inputs[i].value);
            const val2 = parseFloat(s2Inputs[i].value);

            // ×× ×©×ª×™ ×”×ª×™×‘×•×ª ×¨×™×§×•×ª - ××“×œ×’×™× (×‘××§×¨×” ×©×”××©×—×§ × ×’××¨ ×‘ 2-0 ×‘××§×•× 3 ××¢×¨×›×•×ª)
            if (isNaN(val1) && isNaN(val2)) continue;

            const check = validatePingPongScore(val1, val2);
            if (!check.valid) {
                alert(`×©×’×™××” ×‘××¢×¨×›×” ${i+1} ×©×œ ××©×—×§ ${row.cells[0].textContent}: ${check.msg}`);
                return;
            }

            p1TotalPoints += val1;
            p2TotalPoints += val2;
            if (val1 > val2) p1SetWins++; else p2SetWins++;
        }

        // ×‘×“×™×§×” ××™ × ×™×¦×— ××ª ×¨×•×‘ ×”××¢×¨×›×•×ª
        const name1 = row.querySelector(".p1-name").textContent;
        const name2 = row.querySelector(".p2-name").textContent;
        const p1 = players.find(p => p.name === name1);
        const p2 = players.find(p => p.name === name2);

        if (p1SetWins === p2SetWins && p1SetWins > 0) {
            alert(`×©×’×™××” ×‘××©×—×§ ×‘×™×Ÿ ${name1} ×œ-${name2}: ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×ª×™×§×• ×‘××¢×¨×›×•×ª.`);
            return;
        }

        if (p1SetWins > p2SetWins) p1.wins++; else if (p2SetWins > p1SetWins) p2.wins++;
        p1.points += p1TotalPoints;
        p2.points += p2TotalPoints;
    }

    players.sort((a, b) => (b.wins - a.wins) || (b.points - a.points) || (Math.random() - 0.5));
    renderFinalRanking(players, tid, gIndex);
}


// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×“×™×¨×•×’ ×¡×•×¤×™
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×“×™×¨×•×’ ×¡×•×¤×™ - ×’×¨×¡×” ×××•×—×“×ª ×•×ª×§×™× ×”
function renderFinalRanking(players, tid, gIndex) {
  const rankingContainer = document.getElementById(`${tid}_ranking${gIndex}`);
  if (!rankingContainer) return;

  let rankingHTML = `
    <h3>×“×™×¨×•×’ ×¡×•×¤×™ ×‘×™×ª ${gIndex + 1}</h3>
    <table>
      <thead>
        <tr>
          <th>××§×•×</th>
          <th>×©×—×§×Ÿ</th>
          <th>× ×™×¦×—×•× ×•×ª</th>
          <th>× ×§×•×“×•×ª</th>
        </tr>
      </thead>
      <tbody>`;

  players.forEach((p, i) => {
    rankingHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${p.name || '---'}</td>
        <td>${p.wins}</td>
        <td>${p.points}</td>
      </tr>`;
  });

  rankingHTML += `</tbody></table>`;
  rankingContainer.innerHTML = rankingHTML;
}


/* ==== ×¡×™××•×Ÿ ×× ×¦×— ×•×”×¡×¨×ª ×ª×™×‘×•×ª ×§×œ×˜ ==== */
function setAutoWinner(matchDiv, winnerName, label = "×× ×¦×—") {
    // ×”×¡×¨×ª ×ª×™×‘×•×ª ×§×œ×˜ ×§×™×™××•×ª
    matchDiv.querySelectorAll("input").forEach(i => i.remove());
    
    // ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×©×œ ×”×•×“×¢×ª ×”×× ×¦×—
    let wDiv = matchDiv.querySelector(".auto-winner-label");
    if (!wDiv) {
        wDiv = document.createElement("div");
        wDiv.className = "auto-winner-label";
        wDiv.style.color = "green";
        wDiv.style.fontSize = "0.9em";
        wDiv.style.fontWeight = "bold";
        matchDiv.appendChild(wDiv);
    }
    wDiv.textContent = `${label}: ${winnerName}`;
}

function getRoundName(roundIndex, totalRounds) {
    const roundsLeft = totalRounds - roundIndex;
    switch(roundsLeft) {
        case 1: return "×’××¨";
        case 2: return "×—×¦×™ ×’××¨";
        case 3: return "×¨×‘×¢ ×’××¨";
        case 4: return "×©××™× ×™×ª ×’××¨";
        case 5: return "16";
        case 6: return "32";
        default: return `×©×œ×‘ ${roundIndex+1}`;
    }
}

/* ×™×¦×™×¨×ª ×¢×¥ × ×•×§××•×˜ â€“ ×›×•×œ×œ ×˜×™×¤×•×œ BYE ××•×œ BYE */
/* ×™×¦×™×¨×ª ×¢×¥ × ×•×§××•×˜ ××©×•×¤×¨ ×¢× ×§×™×“×•× ×‘×˜×•×— */
function generateKnockout(tid) {
    const tdata = tournaments[tid];
    if (!tdata) return;

    // 1. ×‘×“×™×§×ª ×ª×§×™× ×•×ª: ×”×× ×›×œ ×”×‘×ª×™× ×¡×™×™××• ×—×™×©×•×‘?
    let incompleteGroups = [];
    for (let g = 0; g < tdata.groupCount; g++) {
        const rankingDiv = document.getElementById(`${tid}_ranking${g}`);
        if (!rankingDiv || rankingDiv.innerHTML.trim() === "" || rankingDiv.innerHTML.includes("× ××¦× ×©×•×•×™×•×Ÿ")) {
            incompleteGroups.push(g + 1);
        }
    }

    if (incompleteGroups.length > 0) {
        alert(`×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ × ×•×§××•×˜. ×—×¡×¨ ×“×™×¨×•×’ ×¡×•×¤×™ (××• ×©×™×© ×©×•×•×™×•×Ÿ ×œ× ×¤×ª×•×¨) ×‘×‘×ª×™×: ${incompleteGroups.join(", ")}`);
        return;
    }

    // 2. ××™×¡×•×£ ×©×—×§× ×™× ××•×¡××›×™× (××§×•× 1 ×•-2 ××›×œ ×‘×™×ª)
    let qualified = [];
    for (let g = 0; g < tdata.groups.length; g++) {
        if (tdata.groups[g] && tdata.groups[g].length >= 2) {
            // ×”××¢×¨×š ×›×‘×¨ ×××•×™×Ÿ ××—×¨×™ calculateResults
            let sorted = tdata.groups[g]; 
            if (sorted[0]) qualified.push({ name: sorted[0].name, pos: 1, group: g });
            if (sorted[1]) qualified.push({ name: sorted[1].name, pos: 2, group: g });
        }
    }

    if (qualified.length < 2) {
        alert("××™×Ÿ ××¡×¤×™×§ ×©×—×§× ×™× ×›×“×™ ×œ×™×¦×•×¨ ×¢×¥ × ×•×§××•×˜.");
        return;
    }

    // 3. ×¡×™×“×•×¨ ×©×—×§× ×™× ×œ×× ×™×¢×ª ××¤×’×© ×××•×ª×• ×‘×™×ª (×›×›×œ ×”××¤×©×¨)
    let firsts = qualified.filter(p => p.pos === 1).sort(() => Math.random() - 0.5);
    let seconds = qualified.filter(p => p.pos === 2).sort(() => Math.random() - 0.5);
    let orderedNames = [];

    firsts.forEach(f => {
        orderedNames.push(f.name);
        // ×× ×¡×™× ×œ××¦×•× ××§×•× ×©× ×™ ×©×œ× ×”×’×™×¢ ×××•×ª×• ×‘×™×ª
        let sIdx = seconds.findIndex(s => s.group !== f.group);
        if (sIdx === -1 && seconds.length > 0) sIdx = 0; 
        
        if (sIdx !== -1) {
            orderedNames.push(seconds[sIdx].name);
            seconds.splice(sIdx, 1);
        } else {
            orderedNames.push("BYE");
        }
    });
    // ×”×•×¡×¤×ª ×©××¨×™×ª ×”××§×•××•×ª ×”×©× ×™×™× ×× × ×•×ª×¨×•
    seconds.forEach(s => orderedNames.push(s.name));

    // 4. ×”×©×œ××” ×œ×—×–×§×” ×©×œ 2 (×¢×‘×•×¨ ×¢×¥ ×¡×™××˜×¨×™)
    let roundsCount = Math.ceil(Math.log2(orderedNames.length));
    let size = Math.pow(2, roundsCount);
    while (orderedNames.length < size) orderedNames.push("BYE");

    // 5. ×‘× ×™×™×ª ×”-DOM ×©×œ ×”×‘×¨××§×˜
    const bracketDiv = document.getElementById("bracket" + tid);
    if (!bracketDiv) return;
    bracketDiv.innerHTML = '';
    tdata._bracket = [];

    let currentNames = [...orderedNames];
    for (let r = 0; r < roundsCount; r++) {
        const roundDiv = document.createElement("div");
        roundDiv.className = "round";
        roundDiv.innerHTML = `<h3>${getRoundName(r, roundsCount)}</h3>`;
        tdata._bracket[r] = [];

        let matchesInRound = currentNames.length / 2;
        for (let m = 0; m < matchesInRound; m++) {
            const p1 = currentNames[m * 2] || "";
            const p2 = currentNames[m * 2 + 1] || "";

            const mdiv = document.createElement("div");
            mdiv.className = "match";
            mdiv.dataset.round = r;
            mdiv.dataset.match = m;

            const s1 = document.createElement("span"); s1.className = "p1"; s1.textContent = p1;
            const s2 = document.createElement("span"); s2.className = "p2"; s2.textContent = p2;

            mdiv.appendChild(s1);
            mdiv.appendChild(document.createTextNode(" vs "));
            mdiv.appendChild(s2);
            mdiv.appendChild(document.createElement("br"));

            // ×”×•×¡×¤×ª ×§×œ×˜ ×¨×§ ×œ××©×—×§×™× ×‘×™×Ÿ ×©× ×™ ×©×—×§× ×™× ×××™×ª×™×™×
            if (p1 !== "BYE" && p2 !== "BYE" && p1 !== "" && p2 !== "") {
                const in1 = document.createElement("input");
                const in2 = document.createElement("input");
                in1.type = in2.type = "number";
                in1.style.width = "40px";
                in1.oninput = in2.oninput = () => autoDecideWinner(in1, in2);
                mdiv.appendChild(in1);
                mdiv.appendChild(document.createTextNode(" - "));
                mdiv.appendChild(in2);
            }

            roundDiv.appendChild(mdiv);
            tdata._bracket[r].push(mdiv);
        }
        bracketDiv.appendChild(roundDiv);
        currentNames = new Array(matchesInRound).fill(""); // × ×™×§×•×™ ×©××•×ª ×œ×¡×™×‘×•×‘ ×”×‘×
    }

    // 6. ×”×¤×¢×œ×ª ×§×™×“×•× ××•×˜×•××˜×™ ×œ-BYE (××—×¨×™ ×©×”-DOM ×¨×•× ×“×¨)
    setTimeout(() => {
        tdata._bracket[0].forEach((mdiv, idx) => {
            const p1 = mdiv.querySelector(".p1").textContent;
            const p2 = mdiv.querySelector(".p2").textContent;
            
            if (p1 === "BYE" || p2 === "BYE") {
                const winner = (p1 === "BYE") ? p2 : p1;
                if (winner && winner !== "BYE") {
                    setAutoWinner(mdiv, winner, "×¢×œ×” ××•×˜×•××˜×™×ª");
                    placeInNextRound(tid, 0, idx, winner);
                }
            }
        });
    }, 100);

    openKnockoutTab(tid);
}


/* ×§×™×“×•× ×× ×¦×— ×œ×©×œ×‘ ×”×‘× â€“ ×›×•×œ×œ ×›×œ ××§×¨×™ ×”-BYE */
function placeInNextRound(tid, roundIdx, matchIdx, winnerName) {
    const tdata = tournaments[tid];
    const nextRoundIdx = roundIdx + 1;
    
    // ×× ××™×Ÿ ×¡×™×‘×•×‘ ×”×‘× - ×”×›×¨×– ×¢×œ ××œ×•×£
    if (!tdata._bracket[nextRoundIdx]) {
        const champEl = document.getElementById("champion" + tid);
        if (champEl) {
            champEl.innerHTML = `<h3>ğŸ† ×”××œ×•×£: ${winnerName} ğŸ†</h3>`;
            champEl.style.display = "block";
        }
        return;
    }

    const nextMatchIdx = Math.floor(matchIdx / 2);
    const nextMatchDiv = tdata._bracket[nextRoundIdx][nextMatchIdx];
    if (!nextMatchDiv) return;

    // ×”×©××” ×‘××™×§×•× ×”× ×›×•×Ÿ (×©×—×§×Ÿ ×¢×œ×™×•×Ÿ ××• ×ª×—×ª×•×Ÿ ×‘××©×—×§ ×”×‘×)
    const isP1 = (matchIdx % 2 === 0);
    const targetSpan = isP1 ? nextMatchDiv.querySelector(".p1") : nextMatchDiv.querySelector(".p2");
    
    if (targetSpan) {
        targetSpan.textContent = winnerName;
        targetSpan.style.fontWeight = "bold";
        targetSpan.style.color = "#000";
    }

    // ×‘×“×™×§×” ×× ×”××©×—×§ ×”×‘× ×“×•×¨×© ×§×™×“×•× ××•×˜×•××˜×™ (×œ××©×œ ×× ×”×¦×“ ×”×©× ×™ ×”×•× BYE)
    setTimeout(() => {
        const p1 = nextMatchDiv.querySelector(".p1").textContent.trim();
        const p2 = nextMatchDiv.querySelector(".p2").textContent.trim();

        // ××§×¨×” 1: ×¦×“ ××—×“ ×”×•× ×©×—×§×Ÿ ×•×”×©× ×™ ×”×•× BYE
        if (p1 && p2 === "BYE") {
            setAutoWinner(nextMatchDiv, p1, "×¢×œ×” (BYE)");
            placeInNextRound(tid, nextRoundIdx, nextMatchIdx, p1);
        } 
        else if (p2 && p1 === "BYE") {
            setAutoWinner(nextMatchDiv, p2, "×¢×œ×” (BYE)");
            placeInNextRound(tid, nextRoundIdx, nextMatchIdx, p2);
        }
        // ××§×¨×” 2: ×©× ×™ ×©×—×§× ×™× ×××™×ª×™×™× ×”×’×™×¢×• ×œ××©×—×§ - ×¦×•×¨ ×ª×™×‘×•×ª ×§×œ×˜ ×× ×”×Ÿ ×œ× ×§×™×™××•×ª
        else if (p1 && p2 && p1 !== "BYE" && p2 !== "BYE") {
            if (nextMatchDiv.querySelectorAll("input").length === 0) {
                const in1 = document.createElement("input");
                const in2 = document.createElement("input");
                in1.type = in2.type = "number";
                in1.style.width = "40px";
                in1.oninput = in2.oninput = () => autoDecideWinner(in1, in2);
                nextMatchDiv.appendChild(in1);
                nextMatchDiv.appendChild(document.createTextNode(" - "));
                nextMatchDiv.appendChild(in2);
            }
        }
    }, 50);
}

/* ×”×›×¨×¢×” ×™×“× ×™×ª (×§×œ×˜ ×ª×•×¦××”) â€“ ××¡××Ÿ ×× ×¦×— ×•× ×•×¢×œ ×§×œ×˜ */
function autoDecideWinner(in1, in2) {
    const s1 = parseFloat(in1.value);
    const s2 = parseFloat(in2.value);
    
    // ×‘×“×™×§×” ×× ×”×ª×•×¦××” ×—×•×§×™×ª ×œ××©×—×§ ×¤×™× ×’ ×¤×•× ×’
    const check = validatePingPongScore(s1, s2);
    
    // ×× ×œ× ×—×•×§×™, ×œ× ×¢×•×©×™× ×›×œ×•× (×œ× ××§×“××™×)
    if (!check.valid) {
        in1.style.borderColor = "red";
        in2.style.borderColor = "red";
        return; 
    }

    // ×× ×—×•×§×™ - ×××©×™×›×™× ×‘×§×™×“×•× ×”×©×—×§×Ÿ
    in1.style.borderColor = "";
    in2.style.borderColor = "";
    
    const matchDiv = in1.parentElement;
    const p1 = matchDiv.querySelector(".p1").textContent.trim();
    const p2 = matchDiv.querySelector(".p2").textContent.trim();
    const winner = (s1 > s2) ? p1 : p2;

    const roundIdx = parseInt(matchDiv.dataset.round, 10);
    const matchIdx = parseInt(matchDiv.dataset.match, 10);
    const tid = matchDiv.closest(".bracket").id.replace("bracket", "");

    setAutoWinner(matchDiv, winner, "×× ×¦×—");
    placeInNextRound(tid, roundIdx, matchIdx, winner);
}

function closeTournament(tid){
  document.getElementById(tid).remove();
  document.getElementById("tabbtn_"+tid).remove();
  delete tournaments[tid];
}

function validatePingPongScore(s1, s2) {
    // ×‘×“×™×§×” ×©××“×•×‘×¨ ×‘××¡×¤×¨×™× ×©×œ××™× ×•××™-×©×œ×™×œ×™×™×
    if (isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0 || !Number.isInteger(s1) || !Number.isInteger(s2)) {
        return { valid: false, msg: "× × ×œ×”×–×™×Ÿ ××¡×¤×¨×™× ×©×œ××™× ×•×—×™×•×‘×™×™× ×‘×œ×‘×“." };
    }

    const max = Math.max(s1, s2);
    const min = Math.min(s1, s2);
    const diff = max - min;

    // ×—×•×§ ×”-11 ×”×§×œ××¡×™
    if (max === 11 && min <= 9) return { valid: true };

    // ×—×•×§ ×”"×“×™×•×•×¡" (××¢×œ 10-10)
    if (max > 10 && min >= 10) {
        if (diff === 2) return { valid: true };
        if (diff < 2) return { valid: false, msg: "×‘××¦×‘ ×©×œ ××¢×œ 10 × ×§×•×“×•×ª, ×—×™×™×‘ ×œ×”×™×•×ª ×”×¤×¨×© ×©×œ ×‘×“×™×•×§ 2 × ×§×•×“×•×ª (×œ××©×œ 12-10)." };
        if (diff > 2) return { valid: false, msg: "×ª×•×¦××” ×œ× ×—×•×§×™×ª: ×”×”×¤×¨×© ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×’×“×•×œ ×-2 ×‘× ×§×•×“×•×ª ××œ×•." };
    }

    return { valid: false, msg: "××©×—×§ ×¤×™× ×’-×¤×•× ×’ ×—×™×™×‘ ×œ×”×¡×ª×™×™× ×‘-11 × ×§×•×“×•×ª (××• ×”×¤×¨×© 2 ×‘× ×§×•×“×•×ª ×’×‘×•×”×•×ª ×™×•×ª×¨)." };
}

</script>
<footer>
    <p>Â© 2025 × ×™×”×•×œ ×ª×—×¨×•×™×•×ª ×˜× ×™×¡ ×©×•×œ×—×Ÿ - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ××¨×•× ×©×§×“</p>
</footer>
</body>
</html>